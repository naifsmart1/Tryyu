<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>QR → Google Sheet Logger</title>

  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px}
    #reader{width:100%;min-height:300px;background:#000;border-radius:8px;margin-top:10px}
    .card{max-width:900px;margin:auto;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);border-radius:10px}
    pre{background:#f7f7f7;padding:10px;border-radius:6px;white-space:pre-wrap}
    button, select, input{padding:8px 12px;border-radius:6px;margin-top:8px}
  </style>

  <!-- ✅ Load QR library BEFORE your script -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
<div class="card">
  <h2>Scan QR → Google Sheet</h2>
  <p>Scans are written to your sheet's <strong>Scans</strong> tab.</p>

  <label>Select Camera:</label>
  <select id="cameraSelect"></select>

  <div id="reader"></div>

  <h3>Last action</h3>
  <pre id="status">Waiting for scan…</pre>

  <p>
    Manual test:
    <input id="manual" placeholder="paste QR text here"/>
    <button id="sendManual">Send</button>
  </p>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxCKuPKQTbEdCwyuex8eCovAun5kttJJqiR6J_lmiyMl2i3wtrvQGv9xDLqSVkz-AA6/exec"; // <-- paste your Apps Script URL

const statusEl = document.getElementById("status");
const cameraSelect = document.getElementById("cameraSelect");
let html5QrCode;

// ✅ Send data to Google Apps Script
async function sendPayload(payload){
  try{
    statusEl.textContent = "Sending...";
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ action: "log", payload })
    });

    const data = await res.json();
    statusEl.textContent = "Logged:\n" + JSON.stringify(data, null, 2);
  }catch(err){
    statusEl.textContent = "Send failed: " + err;
  }
}

// ✅ Manual send
document.getElementById("sendManual").onclick = () => {
  const v = document.getElementById("manual").value.trim();
  if(!v) return alert("Enter text");
  sendPayload({ raw: v });
};

// ✅ QR success handler
function onSuccess(decodedText){
  html5QrCode.pause();
  statusEl.textContent = "Scanned: " + decodedText;

  sendPayload({ raw: decodedText }).finally(() => {
    setTimeout(() => html5QrCode.resume(), 1200);
  });
}

// ✅ QR failure handler (ignored)
function onFailure(err){}

// ✅ Initialize camera list + scanner
async function initScanner(){
  try{
    const cameras = await Html5Qrcode.getCameras();

    if(!cameras.length){
      statusEl.textContent = "No camera found";
      return;
    }

    cameras.forEach(cam => {
      const opt = document.createElement("option");
      opt.value = cam.id;
      opt.textContent = cam.label || "Camera";
      cameraSelect.appendChild(opt);
    });

    startCamera(cameras[0].id);

    cameraSelect.onchange = () => {
      html5QrCode.stop().then(() => {
        startCamera(cameraSelect.value);
      });
    };

  }catch(err){
    statusEl.textContent = "Camera error: " + err;
  }
}

// ✅ Start camera
function startCamera(cameraId){
  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    cameraId,
    { fps: 10, qrbox: { width: 280, height: 280 } },
    onSuccess,
    onFailure
  ).catch(err => {
    statusEl.textContent = "Camera start failed: " + err;
  });
}

window.addEventListener("load", initScanner);
</script>

<footer style="padding:20px;text-align:center">@Trytech.2025</footer>
</body>
</html>