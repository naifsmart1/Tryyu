<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Scanner ‚Üí Google Sheet</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  #reader { width: 300px; margin: auto; }
  pre { background: #f2f2f2; padding: 10px; }
</style>

<!-- ‚úÖ STABLE QR LIBRARY (jsDelivr CDN) -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
</head>
<body>

<h2>QR Scanner ‚Üí Google Sheet</h2>

<button id="startBtn">Start Camera</button>

<div id="reader"></div>

<h3>Status</h3>
<pre id="status">Waiting‚Ä¶</pre>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxlaPMia33h61Ye1PV4uj_sisMHdynjor9daNXYeC5ivgj2nBq1Fud2HY3naF2K-m-0/exec";

const statusBox = document.getElementById("status");
const startBtn = document.getElementById("startBtn");

function log(msg) {
  statusBox.textContent = msg;
}

// üîé DEBUG: check if library loaded
if (typeof Html5Qrcode === "undefined") {
  log("‚ùå QR library failed to load");
} else {
  log("‚úÖ QR library loaded");
}

startBtn.onclick = async () => {
  if (typeof Html5Qrcode === "undefined") {
    log("‚ùå Html5Qrcode not available");
    return;
  }

  log("Requesting camera permission‚Ä¶");

  try {
    // Force permission prompt
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(t => t.stop());

    log("Camera permission granted ‚úÖ");

    const qr = new Html5Qrcode("reader");
    const cameras = await Html5Qrcode.getCameras();

    if (!cameras.length) {
      log("No camera found ‚ùå");
      return;
    }

    await qr.start(
      cameras[0].id,
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        log("QR Scanned:\n" + decodedText);
        qr.pause();

        // send to Google Sheet
        try {
          const res = await fetch(WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ qr_data: decodedText })
          });
          const data = await res.json();
          log("Saved to sheet ‚úÖ\n" + JSON.stringify(data, null, 2));
        } catch (e) {
          log("Sheet error ‚ùå\n" + e);
        }

        setTimeout(() => qr.resume(), 2000);
      }
    );

  } catch (err) {
    log("Camera error ‚ùå : " + err.name + " - " + err.message);
  }
};
</script>

</body>
</html>  
