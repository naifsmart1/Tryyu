<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    padding: 20px;
  }
  #reader {
    width: 300px;
    margin: auto;
  }
  pre {
    background: #f2f2f2;
    padding: 10px;
  }
</style>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
</head>
<body>

<h2>QR Scanner → Google Sheet</h2>

<button id="startBtn">Start Camera</button>

<div id="reader"></div>

<h3>Status</h3>
<pre id="status">Waiting…</pre>

<script>
const WEB_APP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

const statusBox = document.getElementById("status");
const startBtn = document.getElementById("startBtn");

let qrScanner = null;

function log(msg) {
  statusBox.textContent = msg;
}

async function sendToSheet(qrText) {
  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ qr_data: qrText })
    });
    const data = await res.json();
    log("Saved to sheet ✅\n" + JSON.stringify(data, null, 2));
  } catch (err) {
    log("Send error ❌\n" + err);
  }
}

startBtn.onclick = async () => {
  log("Requesting camera permission…");

  try {
    // Force permission popup
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    stream.getTracks().forEach(t => t.stop());

    log("Camera permission granted ✅");

    qrScanner = new Html5Qrcode("reader");
    const cameras = await Html5Qrcode.getCameras();

    if (!cameras.length) {
      log("No camera found ❌");
      return;
    }

    await qrScanner.start(
      cameras[0].id,
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        log("QR Scanned:\n" + decodedText);
        qrScanner.pause();
        await sendToSheet(decodedText);
        setTimeout(() => qrScanner.resume(), 2000);
      }
    );

  } catch (err) {
    log("Camera error ❌ : " + err.name + " - " + err.message);
  }
};
</script>

</body>
</html></html>
